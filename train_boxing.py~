#!/usr/bin/env python3
"""
Script d'entraÃ®nement YOLOv11 pour la dÃ©tection de boxe
Utilisation avec un fichier data.yaml existant
"""

import os
import torch
from ultralytics import YOLO
import argparse
import yaml

def check_environment():
    """VÃ©rifie l'environnement et les dÃ©pendances"""
    print("ğŸ” VÃ©rification de l'environnement...")
    
    # VÃ©rifier CUDA
    if torch.cuda.is_available():
        gpu_name = torch.cuda.get_device_name()
        gpu_memory = torch.cuda.get_device_properties(0).total_memory / 1024**3
        print(f"âœ… CUDA disponible - GPU: {gpu_name}")
        print(f"âœ… MÃ©moire GPU: {gpu_memory:.1f} GB")
        device = 'cuda'
    else:
        print("â„¹ï¸  CUDA non disponible - Utilisation du CPU")
        device = 'cpu'
    
    # VÃ©rifier Ultralytics
    try:
        import ultralytics
        print(f"âœ… Ultralytics version: {ultralytics.__version__}")
    except ImportError:
        print("âŒ Ultralytics non installÃ©")
        return None
    
    return device

def validate_data_yaml(data_yaml_path):
    """Valide le fichier data.yaml"""
    print(f"ğŸ“‹ Validation du fichier data.yaml: {data_yaml_path}")
    
    if not os.path.exists(data_yaml_path):
        print(f"âŒ Fichier {data_yaml_path} non trouvÃ©")
        return False
    
    try:
        with open(data_yaml_path, 'r') as f:
            data_config = yaml.safe_load(f)
        
        # VÃ©rifier les champs obligatoires
        required_fields = ['train', 'val', 'nc', 'names']
        for field in required_fields:
            if field not in data_config:
                print(f"âŒ Champ manquant dans data.yaml: {field}")
                return False
        
        print(f"âœ… Fichier data.yaml valide")
        print(f"   - Classes: {data_config['nc']}")
        print(f"   - Noms: {data_config['names']}")
        print(f"   - Train: {data_config['train']}")
        print(f"   - Val: {data_config['val']}")
        
        return True
        
    except Exception as e:
        print(f"âŒ Erreur lors de la lecture du data.yaml: {e}")
        return False

def train_yolo11_model(data_yaml_path, epochs=100, imgsz=1024, batch_size=8, model_size='n'):
    """
    EntraÃ®ne un modÃ¨le YOLOv11
    
    Args:
        data_yaml_path (str): Chemin vers le fichier data.yaml
        epochs (int): Nombre d'Ã©poques d'entraÃ®nement
        imgsz (int): Taille des images
        batch_size (int): Taille du batch
        model_size (str): Taille du modÃ¨le (n, s, m, l, x)
    """
    
    print("ğŸš€ DÃ©marrage de l'entraÃ®nement YOLOv11...")
    print(f"ğŸ“Š Configuration:")
    print(f"   - Data: {data_yaml_path}")
    print(f"   - Ã‰poques: {epochs}")
    print(f"   - Taille image: {imgsz}")
    print(f"   - Batch size: {batch_size}")
    print(f"   - Taille modÃ¨le: {model_size}")
    
    # Charger le modÃ¨le YOLOv11 prÃ©-entraÃ®nÃ©
    print("ğŸ“¦ Chargement du modÃ¨le YOLOv11...")
    
    model_map = {
        'n': 'yolo11n.pt',
        's': 'yolo11s.pt', 
        'm': 'yolo11m.pt',
        'l': 'yolo11l.pt',
        'x': 'yolo11x.pt'
    }
    
    model_name = model_map.get(model_size, 'yolo11n.pt')
    
    try:
        model = YOLO(model_name)
        print(f"âœ… ModÃ¨le chargÃ©: {model_name}")
    except Exception as e:
        print(f"âŒ Erreur lors du chargement de {model_name}: {e}")
        print("ğŸ”„ Tentative avec YOLOv8...")
        try:
            model = YOLO('yolov8n.pt')
            print("âœ… ModÃ¨le YOLOv8 chargÃ© en fallback")
        except Exception as e2:
            print(f"âŒ Erreur critique: {e2}")
            return None
    
    # EntraÃ®nement du modÃ¨le
    print("ğŸ¯ DÃ©but de l'entraÃ®nement...")
    
    try:
        results = model.train(
            data=data_yaml_path,
            epochs=epochs,
            imgsz=imgsz,
            batch=batch_size,
            patience=15,  # ArrÃªt prÃ©coce
            save=True,
            save_period=10,
            cache=False,  # DÃ©sactiver le cache si peu de RAM
            device='0' if torch.cuda.is_available() else 'cpu',
            workers=4,
            optimizer='AdamW',
            lr0=0.001,
            cos_lr=True,
            flipud=0.1,
            fliplr=0.5,
            mosaic=0.5,
            mixup=0.1,
            copy_paste=0.1,
            name=f'boxing_yolo11_{model_size}',
            exist_ok=True,
            verbose=True
        )
        
        print("âœ… EntraÃ®nement terminÃ© avec succÃ¨s!")
        return results
        
    except Exception as e:
        print(f"âŒ Erreur lors de l'entraÃ®nement: {e}")
        return None

def evaluate_best_model(project_dir, data_yaml_path, imgsz=1024):
    """Ã‰value le meilleur modÃ¨le entraÃ®nÃ©"""
    print("ğŸ“ˆ Ã‰valuation du modÃ¨le...")
    
    # Trouver le meilleur modÃ¨le
    best_model_path = os.path.join(project_dir, 'weights', 'best.pt')
    
    if not os.path.exists(best_model_path):
        print(f"âŒ Fichier du meilleur modÃ¨le non trouvÃ©: {best_model_path}")
        # Chercher dans d'autres emplacements possibles
        possible_paths = [
            best_model_path,
            './runs/detect/boxing_yolo11/weights/best.pt',
            './runs/detect/train/weights/best.pt'
        ]
        
        for path in possible_paths:
            if os.path.exists(path):
                best_model_path = path
                print(f"âœ… ModÃ¨le trouvÃ©: {best_model_path}")
                break
        else:
            print("âŒ Aucun modÃ¨le best.pt trouvÃ©")
            return None
    
    try:
        # Charger le modÃ¨le entraÃ®nÃ©
        model = YOLO(best_model_path)
        
        # Ã‰valuation
        metrics = model.val(
            data=data_yaml_path,
            imgsz=imgsz,
            batch=4,
            save_json=True,
            conf=0.25,
            iou=0.6
        )
        
        print("ğŸ“Š MÃ©triques d'Ã©valuation:")
        print(f"   - mAP50: {metrics.box.map50:.3f}")
        print(f"   - mAP50-95: {metrics.box.map:.3f}")
        print(f"   - PrÃ©cision: {metrics.box.mp:.3f}")
        print(f"   - Rappel: {metrics.box.mr:.3f}")
        
        return metrics
        
    except Exception as e:
        print(f"âŒ Erreur lors de l'Ã©valuation: {e}")
        return None

def main():
    """Fonction principale"""
    parser = argparse.ArgumentParser(description='EntraÃ®nement YOLOv11 pour la boxe avec data.yaml existant')
    parser.add_argument('--data-yaml', type=str, required=True, 
                       help='Chemin vers le fichier data.yaml')
    parser.add_argument('--epochs', type=int, default=100, 
                       help='Nombre d\'Ã©poques (dÃ©faut: 100)')
    parser.add_argument('--imgsz', type=int, default=1024, 
                       help='Taille des images (dÃ©faut: 1024)')
    parser.add_argument('--batch-size', type=int, default=8, 
                       help='Taille du batch (dÃ©faut: 8)')
    parser.add_argument('--model-size', type=str, default='n', choices=['n', 's', 'm', 'l', 'x'],
                       help='Taille du modÃ¨le: n(nano), s(small), m(medium), l(large), x(xlarge)')
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("ğŸ¥Š ENTRAÃNEMENT YOLOv11 - DÃ‰TECTION BOXE")
    print("=" * 60)
    
    # VÃ©rifier l'environnement
    device = check_environment()
    if device is None:
        return
    
    # Valider le fichier data.yaml
    if not validate_data_yaml(args.data_yaml):
        return
    
    # Ajuster la batch size selon le device
    if device == 'cpu' and args.batch_size > 4:
        print("âš ï¸  RÃ©duction de la batch size pour CPU")
        args.batch_size = 4
    
    # EntraÃ®ner le modÃ¨le
    results = train_yolo11_model(
        data_yaml_path=args.data_yaml,
        epochs=args.epochs,
        imgsz=args.imgsz,
        batch_size=args.batch_size,
        model_size=args.model_size
    )
    
    if results is not None:
        # Ã‰valuer le modÃ¨le
        project_dir = f'./runs/detect/boxing_yolo11_{args.model_size}'
        evaluate_best_model(project_dir, args.data_yaml, args.imgsz)
        
        print("\nğŸ‰ EntraÃ®nement terminÃ© avec succÃ¨s!")
        print(f"ğŸ“ RÃ©sultats dans: {project_dir}")
        print(f"ğŸ† Meilleur modÃ¨le: {project_dir}/weights/best.pt")
        
        # Afficher les chemins importants
        print("\nğŸ“‚ Fichiers gÃ©nÃ©rÃ©s:")
        print(f"   - ModÃ¨le final: {project_dir}/weights/best.pt")
        print(f"   - MÃ©triques: {project_dir}/results.csv")
        print(f"   - Graphiques: {project_dir}/plots/")
        print(f"   - Logs: {project_dir}/")
        
    else:
        print("\nâŒ L'entraÃ®nement a Ã©chouÃ©")

if __name__ == "__main__":
    main()